name: Deploy to AWS (CD)

on:
  push:
    branches: [main]

jobs:
  # JOB 1: DEPLOY FRONTEND (Client Folder)
  deploy-frontend:
    name: Deploy React Frontend
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: Client/package-lock.json

      - name: Install Dependencies
        working-directory: ./Client
        run: npm ci

      - name: Build React App
        working-directory: ./Client
        run: npm run build
        env:
          VITE_API_URL: "http://${{ secrets.SSH_HOST }}/api/v1"

      - name: Upload to AWS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          source: "Client/dist/*"
          target: "/var/www/html/smartshift-frontend"
          strip_components: 2 # Removes "Client/dist" from the path

  # JOB 2: DEPLOY BACKEND (Server Folder)
  deploy-backend:
    name: Deploy Laravel Backend
    runs-on: ubuntu-latest
    needs: deploy-frontend

    steps:
      - name: Update Backend on Server
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -e

            echo " Starting Backend Deployment..."

            # 1. Navigate to the main repo folder
            cd /var/www/html/smartshift

            # 2. Force 'ubuntu' to take ownership so Git can write
            sudo chown -R ubuntu:ubuntu .

            # 3. Pull the latest code (Client & Server folders)
            git fetch origin main
            git reset --hard origin/main

            # 4. Enter the NEW Server folder
            cd Server

            # 5. Nuke old vendor to prevent conflicts
            echo " Nuke broken vendor folder..."
            rm -rf vendor

            # 6. Install Dependencies (Ignoring PHP 8.3 mismatch)
            /usr/local/bin/composer install --no-interaction --prefer-dist --optimize-autoloader --no-dev --ignore-platform-reqs

            # 7. Run Migrations & Cache
            php artisan migrate --force
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache

            # 8. Give permissions BACK to Apache
            sudo chown -R www-data:www-data storage bootstrap/cache
            sudo chmod -R 775 storage bootstrap/cache

            # 9. Reload Apache
            sudo systemctl reload apache2

            echo " Deployment Finished Successfully!"
