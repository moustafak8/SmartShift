name: SmartShift Full Stack CD

on:
  push:
    branches: [main]

jobs:
  # JOB 1: DEPLOY FRONTEND (Build locally -> Upload to Server)
  deploy-frontend:
    name: Deploy React Frontend
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 20
          cache: "npm"

      - name: Install Dependencies
        run: npm ci

      - name: Build React App
        run: npm run build
        env:
          VITE_API_BASE_URL: "http://${{ secrets.SSH_HOST }}/api"

      - name: Upload to AWS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          source: "dist/*"
          target: "/var/www/html/smartshift-frontend"
          strip_components: 1

  # JOB 2: DEPLOY BACKEND (SSH -> Git Pull -> Update)
  deploy-backend:
    name: Deploy Laravel Backend
    runs-on: ubuntu-latest
    needs: deploy-frontend # Run frontend first

    steps:
      - name: Update Backend on Server
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -e

            echo "Starting Backend Deployment..."

            # 1. Navigate to the main repo folder
            cd /var/www/html/smartshift

            # 2. Force 'ubuntu' to take ownership
            sudo chown -R ubuntu:ubuntu .

            # 3. Pull the latest code
            git fetch origin main
            git reset --hard origin/main

            # 4. Update Laravel Dependencies
            cd backend


            echo " Nuke broken vendor folder..."
            rm -rf vendor

            # install fresh composer dependencies
            /usr/local/bin/composer install --no-interaction --prefer-dist --optimize-autoloader --no-dev --ignore-platform-reqs

            # 5. Run Migrations & Cache
            php artisan migrate --force
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache

            # 6. Give permissions BACK to Apache
            sudo chown -R www-data:www-data storage bootstrap/cache
            sudo chmod -R 775 storage bootstrap/cache

            # 7. Reload Apache
            sudo systemctl reload apache2

            echo " Deployment Finished Successfully!"
